<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>CALENMINI</title>

    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>

    {% if session.get('tipo') == 'admin' %}
    <a href="{{ url_for('usuarios') }}">
        <button>Gerenciar Usuários</button>
    </a>
    {% endif %} 

    <style>
        body {
            font-family: Arial;
            margin: 40px;
        }

        #calendar {
            max-width: 900px;
            margin: 0 auto;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <h2>Bem-vindo, {{ current_user.username }}</h2>
    <a href="/logout">Sair</a>
</div>

<select id="filtroMotorista">
    <option value="">Todos os motoristas</option>
</select>

<div id="calendar"></div>

<script>
document.addEventListener('DOMContentLoaded', function () {

        fetch('/motoristas')
        .then(response => response.json())
        .then(data => {
            let select = document.getElementById("filtroMotorista");

            data.forEach(m => {
                let option = document.createElement("option");
                option.value = m;
                option.textContent = m;
                select.appendChild(option);
            });
        });

        function carregarMotoristas() {

            fetch('/motoristas')
            .then(response => response.json())
            .then(data => {

                let select = document.getElementById("filtroMotorista");

                // limpa opções antigas
                select.innerHTML = '<option value="">Todos os motoristas</option>';

                data.forEach(m => {
                    let option = document.createElement("option");
                    option.value = m;
                    option.textContent = m;
                    select.appendChild(option);
                });

            });
        }


    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'pt-br',
        selectable: true,

        events: function(fetchInfo, successCallback, failureCallback) {

        let motoristaSelecionado = document.getElementById("filtroMotorista").value;

        fetch('/buscar_viagens')
        .then(response => response.json())
        .then(data => {

            if (motoristaSelecionado) {
                data = data.filter(event => 
                    event.extendedProps.motorista === motoristaSelecionado
                );
            }

            successCallback(data);
        });

    },

    
        eventDidMount: function(info) {

            info.el.setAttribute("title", 
            "Local: " + info.event.extendedProps.local + "\n" +
            "Motorista: " + info.event.extendedProps.motorista + "\n" +
            "Observação: " + info.event.extendedProps.observacao
              );
        },

        eventClick: function(info) {

           if (confirm("Deseja excluir esta viagem?")) {

            fetch('/excluir_viagem/' + info.event.id, {
                method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            alert("Viagem excluída!");
            calendar.refetchEvents();
            carregarMotoristas();
        });

    }

},


        dateClick: function(info) {

            let local = prompt("Local da viagem:");
            if (!local) return;

            let motorista = prompt("Motorista:");
            let observacao = prompt("Observação:");

            fetch('/salvar_viagem', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: info.dateStr,
                    local: local,
                    motorista: motorista,
                    observacao: observacao
                })
            })
            .then(response => response.json())
            .then(data => {
                alert("Viagem salva com sucesso!");
                calendar.refetchEvents();
                carregarMotoristas();
            });

        }
    });

    calendar.render();

    document.getElementById("filtroMotorista").addEventListener("change", function() {
    calendar.refetchEvents();
});
});
</script>


</body>
</html>
